---
- name: üîí Apply Basic Server Hardening for DevSecOps
  hosts: all  # –¶–µ–ª–µ–≤—ã–µ —Ö–æ—Å—Ç—ã (–º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –≥—Ä—É–ø–ø—É –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ)
  become: yes  # –ó–∞–ø—É—Å–∫ —Å –ø–æ–≤—ã—à–µ–Ω–Ω—ã–º–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º–∏ (sudo)
  vars:
    # –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–º —Ä–∞–∑—Ä–µ—à–µ–Ω SSH –¥–æ—Å—Ç—É–ø
    allowed_ssh_users: "deployuser adminuser"
    # –°–ø–∏—Å–æ–∫ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∏ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
    weak_kex_algorithms: "diffie-hellman-group1-sha1,diffie-hellman-group14-sha1"
    weak_ciphers: "3des-cbc,aes128-cbc,aes192-cbc,aes256-cbc"

  tasks:
    - name: "üõ°Ô∏è 1. Ensure SSH root login is disabled"
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin no'
        state: present
      notify: restart sshd

    - name: "üõ°Ô∏è 2. Configure allowed SSH users"
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?AllowUsers'
        line: "AllowUsers {{ allowed_ssh_users }}"
        state: present
      notify: restart sshd

    - name: "üõ°Ô∏è 3. Disable weak SSH Key Exchange Algorithms and Ciphers"
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?KexAlgorithms'
        line: "KexAlgorithms {{ weak_kex_algorithms }}"
        state: absent
      notify: restart sshd

    - name: "üõ°Ô∏è 4. Install and configure fail2ban to prevent brute-force attacks"
      ansible.builtin.package:
        name: fail2ban
        state: latest
      notify: restart fail2ban

    - name: "üõ°Ô∏è 5. Ensure firewall (UFW) is enabled and allows only SSH and HTTP/HTTPS"
      community.general.ufw:
        rule: allow
        name: "{{ item }}"
        state: enabled
      loop:
        - ssh
        - http
        - https
      ignore_errors: yes  # –ù–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ UFW –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

  handlers:
    - name: restart sshd
      ansible.builtin.service:
        name: sshd
        state: restarted
        enabled: yes

    - name: restart fail2ban
      ansible.builtin.service:
        name: fail2ban
        state: restarted
        enabled: yes
