---
- name: üîç SCAN: Container Image and Dependencies for Vulnerabilities
  hosts: localhost  
  vars:
    image_name: "my-app:latest"  # –ò–º—è —Å–∫–∞–Ω–∏—Ä—É–µ–º–æ–≥–æ Docker-–æ–±—Ä–∞–∑–∞
    requirements_path: "requirements.txt"  # –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Python

  tasks:
    - name: "1. üê≥ Install Trivy (if not installed)"
      block:
        - name: Download Trivy installer
          ansible.builtin.get_url:
            url: "https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.49.1_Linux-64bit.deb"
            dest: "/tmp/trivy.deb"
            mode: '0755'
        - name: Install Trivy from .deb package
          ansible.builtin.apt:
            deb: "/tmp/trivy.deb"
      become: yes

    - name: "2. üîé Scan local Docker image for vulnerabilities with Trivy"
      community.docker.docker_image_info:
        name: "{{ image_name }}"
      register: image_info

    - name: Run Trivy scan and fail if critical vulnerabilities are found
      ansible.builtin.command:
        cmd: "trivy image --exit-code 1 --severity CRITICAL,HIGH {{ image_name }}"
      register: trivy_scan_result
      failed_when:
        - trivy_scan_result.rc != 0
        - "'ERROR' not in trivy_scan_result.stderr"  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏ —Ç.–¥., –Ω–æ –Ω–µ –æ—à–∏–±–∫–∏ –Ω–∞–ª–∏—á–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π.

    - name: "3. üêç Install Safety (Python vulnerability scanner)"
      ansible.builtin.pip:
        name: safety
        state: latest

    - name: "4. üì¶ Scan Python dependencies for known vulnerabilities"
      ansible.builtin.command:
        cmd: "safety check --file {{ requirements_path }} --full-report"
      register: safety_scan_result
      failed_when: safety_scan_result.rc != 0
      ignore_errors: yes  # –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ 'no' –¥–ª—è —Å—Ç—Ä–æ–≥–æ–≥–æ —Ä–µ–∂–∏–º–∞

    - name: "5. üìÑ Save scan reports as artifacts (for CI/CD)"
      ansible.builtin.copy:
        content: |
          TRIVY SCAN REPORT:
          {{ trivy_scan_result.stdout }}

          SAFETY SCAN REPORT:
          {{ safety_scan_result.stdout }}
        dest: "./security-scan-report-{{ ansible_date_time.epoch }}.txt"
